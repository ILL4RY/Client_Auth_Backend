generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id              Int                     @id @default(autoincrement())
  nombres         String
  apellido_p      String
  apellido_m      String
  correo          String                  @unique
  pais_celular    String?
  celular         String?
  contraseña      String
  f_nacimiento    DateTime?
  tipo_documento  String
  nro_documento   String
  activo          Boolean                 @default(true)
  avatar          String?
  genero          String?
  created_at      DateTime                @default(now())
  updated_at      DateTime                @updatedAt

  dispositivos    Dispositivo[]
  listaDeseos     ListaDeseos?
  notificaciones  Notificacion[]
  preferencias    Preferencia?
  roles           UsuarioRol[]
  consentimientos UsuarioConsentimiento[]
  direcciones     Direccion[]

  @@map("usuarios")
}

model Rol {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  activo      Boolean      @default(true)

  permisos    RolPermiso[]
  usuarios    UsuarioRol[]

  @@map("roles")
}

model Permiso {
  id          Int          @id @default(autoincrement())
  nombre      String
  descripcion String
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  activo      Boolean      @default(true)

  roles       RolPermiso[]

  @@map("permisos")
}

model Consentimiento {
  id            Int                     @id @default(autoincrement())
  nombre        String
  created_at    DateTime                @default(now())
  updated_at    DateTime                @updatedAt
  activo        Boolean                 @default(true)
  descripcion   String?
  obligatorio   Boolean                 @default(false)
  vigente_desde DateTime                @default(now())
  vigente_hasta DateTime?

  usuarios      UsuarioConsentimiento[]

  @@map("consentimientos")
}

model UsuarioRol {
  usuario_id Int
  rol_id     Int
  created_at DateTime @default(now())

  rol        Rol      @relation(fields: [rol_id], references: [id])
  usuario    Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@id([usuario_id, rol_id])
  @@map("usuario_rol")
}

model RolPermiso {
  rol_id     Int
  permiso_id Int
  created_at DateTime @default(now())

  permiso    Permiso  @relation(fields: [permiso_id], references: [id])
  rol        Rol      @relation(fields: [rol_id], references: [id])

  @@id([rol_id, permiso_id])
  @@map("rol_permiso")
}

model Preferencia {
  id                Int      @id @default(autoincrement())
  usuario_id        Int      @unique
  tema              String?
  idioma            String?
  notificaciones_on Boolean  @default(true)
  marketing_emails  Boolean  @default(false)
  privacidad_nivel  String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  usuario           Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("preferencias")
}

model Notificacion {
  id          Int      @id @default(autoincrement())
  usuario_id  Int
  titulo      String
  mensaje     String
  leida       Boolean  @default(false)
  tipo        String?
  fecha_envio DateTime @default(now())

  usuario     Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

model Dispositivo {
  id            Int      @id @default(autoincrement())
  usuario_id    Int
  tipo          String?
  sistema       String?
  navegador     String?
  direccion_ip  String?
  ultimo_acceso DateTime @default(now())
  estado        String?

  usuario       Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("dispositivos")
}

model ListaDeseos {
  id          Int               @id @default(autoincrement())
  usuario_id  Int               @unique
  nombre      String            @default("Lista principal")
  descripcion String?
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  items       ItemListaDeseos[]

  usuario     Usuario           @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("listas_deseos")
}

model ItemListaDeseos {
  id          Int         @id @default(autoincrement())
  lista_id    Int
  producto_id Int
  created_at  DateTime    @default(now())

  lista       ListaDeseos @relation(fields: [lista_id], references: [id], onDelete: Cascade)

  @@map("items_lista_deseos")
}

model UsuarioConsentimiento {
  id                Int            @id @default(autoincrement())
  usuario_id        Int
  consentimiento_id Int
  aceptado          Boolean
  created_at        DateTime?      @default(now())
  
  consentimiento    Consentimiento @relation(fields: [consentimiento_id], references: [id], onDelete: Cascade)
  usuario           Usuario        @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@unique([usuario_id, consentimiento_id])
  @@map("usuarios_consentimientos")
}

model session {
  sid    String   @id @db.VarChar(255)
  sess   Json
  expire DateTime @db.Timestamptz(6)

  @@index([expire], map: "IDX_session_expire")
  @@map("session")
}

model Direccion {
  id             Int       @id @default(autoincrement())
  calle          String
  ciudad         String
  estado         String?
  pais           String
  codigo_postal  String?
  isDefault      Boolean   @default(false)

  // Relación con el usuario
  usuario_id     Int
  usuario        Usuario   @relation(fields: [usuario_id], references: [id])

  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  @@map("direcciones")
}